<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/common/packetRouter.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.AjaxPersistenceQueue.html">ozpIwc.AjaxPersistenceQueue</a></li>
            
                <li><a href="../classes/ozpIwc.ApiBase.html">ozpIwc.ApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.html">ozpIwc.apiFilter</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.Function.html">ozpIwc.apiFilter.Function</a></li>
            
                <li><a href="../classes/ozpIwc.ApiNode.html">ozpIwc.ApiNode</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.BadActionError.html">ozpIwc.BadActionError</a></li>
            
                <li><a href="../classes/ozpIwc.BadContentError.html">ozpIwc.BadContentError</a></li>
            
                <li><a href="../classes/ozpIwc.BadRequestError.html">ozpIwc.BadRequestError</a></li>
            
                <li><a href="../classes/ozpIwc.BadResourceError.html">ozpIwc.BadResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.BadStateError.html">ozpIwc.BadStateError</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.ClientParticipant.html">ozpIwc.ClientParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataNode.html">ozpIwc.DataNode</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsInFlightNode.html">ozpIwc.IntentsInFlightNode</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Bound.html">ozpIwc.Lifespan.Bound</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Ephemeral.html">ozpIwc.Lifespan.Ephemeral</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Persistent.html">ozpIwc.Lifespan.Persistent</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApi.html">ozpIwc.LocksApi</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApiValue.html">ozpIwc.LocksApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesNode.html">ozpIwc.NamesNode</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.NoActionError.html">ozpIwc.NoActionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoMatchError.html">ozpIwc.NoMatchError</a></li>
            
                <li><a href="../classes/ozpIwc.NoPermissionError.html">ozpIwc.NoPermissionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoResourceError.html">ozpIwc.NoResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.standardApiFilters.html">ozpIwc.standardApiFilters</a></li>
            
                <li><a href="../classes/ozpIwc.SystemNode.html">ozpIwc.SystemNode</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.service.html">bus.service</a></li>
            
                <li><a href="../modules/bus.service.Type.html">bus.service.Type</a></li>
            
                <li><a href="../modules/bus.service.Value.html">bus.service.Value</a></li>
            
                <li><a href="../modules/bus.service.Value.Persistance.html">bus.service.Value.Persistance</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/common/packetRouter.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 *
 * @class packetRouter
 * @namespace ozpIwc
 * @static
 */
ozpIwc.packetRouter = ozpIwc.packetRouter || {};

/**
 * Generates a template function to deserialize a uri string based on the RegExp pattern provided.
 *
 * @method uriTemplate
 * @static
 * @param {String} pattern
 * @returns {Function} If the uri does not meet the template criteria, null will be returned when the returned
 *                     function is invoked.
 */
ozpIwc.packetRouter.uriTemplate=function(pattern) {
  var fields=[];
  var modifiedPattern=&quot;^&quot;+pattern.replace(/\{.+?\}|[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, function(match) {
      if(match.length===1) {
          return &quot;\\&quot;+match;
      }
      var colon=match.indexOf(&quot;:&quot;);
      
      if(colon &gt; 0) {
          fields.push(match.slice(1,colon));
          return &quot;(&quot;+match.slice(colon+1,-1)+&quot;)&quot;;
      } else {
        fields.push(match.slice(1,-1));
        return &quot;([^\/]+)&quot;;
      }
  })+&quot;$&quot;;
  var regex=new RegExp(modifiedPattern);
  
  return function(input) {
     var results=regex.exec(input);
     if(!results) {
         return null;
     }
     var obj={};
     for(var i=1;i&lt;results.length;++i) {
         obj[fields[i-1]]=results[i];
     }
     return obj;
  };
    
};

/**
 * A routing module for packet controlling via template matching and filtering.
 * @class PacketRouter
 * @namespace ozpIwc
 */
ozpIwc.PacketRouter=function() {
    /**
     * The key on this table is the route action.
     * The value is an array of config objects of the form:
     *    action: from the route declaration
     *    resource: from the route declaration
     *    handler: the function from the route declaration
     *    uriTemplate: uriTemplate function
     * @property routes
     * @type {Object}
     */
    this.routes={};

    /**
     * The route that matches all packet handling requests. Should defined route be able to handle a packet, this route
     * is called. Can be changed using the declareDefaultRoute method.
     *
     * @property defaultRoute
     * @returns {*}
     */
    this.defaultRoute=function() { return false; };

    /**
     * The default scope of the router.
     * @type {PacketRouter}
     */
    this.defaultSelf=this;
};


/**
 * Assigns a route to the Packet Router for the specific action. This route is taken by a packet if its resource matches
 * the routes resource template, passes any assigned filters. Additionally, a packet may only take one route, if
 * multiple possible routes are possible, the route which was declared earliest will handle the packet.
 *
 * @method declareRoute
 * @param {Object} config
 * @param {String} config.action The action this route is defined to (ex. &quot;get&quot;, &quot;set&quot;, &quot;list&quot;, ...)
 * @param {String} config.resource The serialized uri template definition pertaining to the route (ex. &quot;/foo&quot;, &quot;/{id:\\d+}&quot;, &quot;/{param1}/{param2}&quot;)
 * @param {Array} config.filters Any filters that better isolate the packet routing based on the context and packet properties
 * @param {Function} handler The resulting action to be taken should this route handle a packet.
 * @param {Object}handlerSelf The scope of the handler, the PacketRouter object holds the default scope if none is provided.
 *
 * @returns {ozpIwc.PacketRouter}
 */
ozpIwc.PacketRouter.prototype.declareRoute=function(config,handler,handlerSelf) {
    if(!config || !config.action || !config.resource) {
        throw new Error(&quot;Bad route declaration: &quot;+JSON.stringify(config,null,2));
    }
    config.handler=handler;
    config.filters=config.filters || [];
    config.handlerSelf=handlerSelf;
    config.uriTemplate=ozpIwc.packetRouter.uriTemplate(config.resource);
    
    // @TODO FIXME var actions=ozpIwc.util.ensureArray(config.action);
    var actions=ozpIwc.util.ensureArray(config.action);
    
    actions.forEach(function(a) {
        if(!this.routes.hasOwnProperty(a)) {
            this.routes[a]=[];
        }
    
        this.routes[a].push(config);
    },this);
    return this;
};

/**
 * Recursively passes through all filters for the packet, calling the handler only if all filters pass.
 *
 * @method filterChain
 * @param {Object} packet
 * @param {Object} context
 * @param {Object} pathParams
 * @param {Object} routeSpec
 * @param {Array} filters
 * @returns {Function|null} The handler function should all filters pass.
 */
ozpIwc.PacketRouter.prototype.filterChain=function(packet,context,pathParams,routeSpec,thisPointer,filters) {
  // if there&#x27;s no more filters to call, just short-circuit the filter chain
  if(!filters.length) {
    return routeSpec.handler.call(thisPointer,packet,context,pathParams);
  }
  // otherwise, chop off the next filter in queue and return it.
  var currentFilter=filters.shift();
  var self=this;
  var filterCalled=false;
  var returnValue=currentFilter.call(thisPointer,packet,context,pathParams,function() {
      filterCalled=true;
      return self.filterChain(packet,context,pathParams,routeSpec,thisPointer,filters);
  });
  if(!filterCalled) {
      ozpIwc.log.info(&quot;Filter did not call next() and did not throw an exception&quot;,currentFilter);
  } else {
      ozpIwc.log.debug(&quot;Filter returned &quot;, returnValue);
  }
  return returnValue;  
};

/**
 * Routes the given packet based on the context provided.
 *
 * @method routePacket
 * @param {Object} packet
 * @param {Object} context
 * @param {Object} routeOverrides - if it exists, this to determine the route instead of the packet
 * @returns {*} The output of the route&#x27;s handler. If the specified action does not have any routes false is
 *                    returned. If the specified action does not have a matching route the default route is applied
 */
ozpIwc.PacketRouter.prototype.routePacket=function(packet,context,thisPointer,routeOverrides) {
    routeOverrides = routeOverrides || {};    
    var action=routeOverrides.action || packet.action;
    var resource=routeOverrides.resource || packet.resource;
    
    if(!action || !resource) {
        context.defaultRouteCause=&quot;nonRoutablePacket&quot;;
        return this.defaultRoute.call(thisPointer,packet,context,{});                
    }
    
    context=context || {};
    thisPointer=thisPointer || this.defaultSelf;
    if(!this.routes.hasOwnProperty(action)) {
        context.defaultRouteCause=&quot;noAction&quot;;
        return this.defaultRoute.call(thisPointer,packet,context,{});
    }
    var actionRoutes=this.routes[action];
    for(var i=0;i&lt;actionRoutes.length;++i) {
        var route=actionRoutes[i];
        if(!route) {
            continue;
        }
        var pathParams=route.uriTemplate(resource);
        if(pathParams) {
            thisPointer=route.handlerSelf || thisPointer;
            var filterList=route.filters.slice();
            return this.filterChain(packet,context,pathParams,route,thisPointer,filterList);
        }
    }
    // if we made it this far, then we know about the action, but there are no resources for it
    context.defaultRouteCause=&quot;noResource&quot;;
    return this.defaultRoute.call(thisPointer,packet,context,{});        
    
};

/**
 * Assigns the default route for the Packet Router
 *
 * @param {Function} handler
 */
ozpIwc.PacketRouter.prototype.declareDefaultRoute=function(handler) {
    this.defaultRoute=handler;
};


/**
 * Augments the provided class with a class-level router
 * and routing functions on the prototype.  This allows the use of
 * &quot;declareRoute&quot; on the class to create routes for all instances of
 * that class.  All filters and handlers are evaluated using the
 * instance as &quot;this&quot;.
 * 
 * Defines:
 *    classToAugment.declareRoute(routeConfig,handler)
 *    classToAugment.prototype.routePacket(packet,context);
 * 
 * If the instance has a &quot;defaultRoute&quot; member, it will be used as the
 * default route for packets.
 * 
 * Example:
 *    ozpIwc.PacketRouter.mixin(MyClass);
 *    
 *    MyClass.declareRoute({
 *       action: &quot;get&quot;,
 *       resource: &quot;/foo/{id}&quot;
 *    },function (packet,context,pathParams) {
 *       console.log(&quot;Foo handler&quot;,packet,context,pathParams);     
 *       return &quot;foo handler&quot;;
 *    });
 * 
 *    MyClass.prototype.defaultRoute=function(packet,context) {
 *      console.log(&quot;Default handler&quot;,packet,context,pathParams);
 *      return &quot;default!&quot;;
 *    };
 * 
 *    var instance=new MyClass();
 *
 *    var packet1={ resource: &quot;/foo/123&quot;, action: &quot;get&quot;, ...}
 *    var rv=instance.routePacket(packet1,{ bar: 2});
 *    // console output: Foo handler, packet1, {bar:2}, {id: 123}
 *    // rv === &quot;foo handler&quot;
 *    
 *    var packet2={ resource: &quot;/dne/123&quot;, action: &quot;get&quot;, ...}
 *    rv=instance.routePacket(packet2,{ bar: 3});
 *    // console output: Default handler, packet2, {bar:3}
 *    // rv === &quot;default!&quot;
 * 
 * @param {type} classToAugment
 * @returns {undefined}
 */
ozpIwc.PacketRouter.mixin=function(classToAugment) {
    var packetRouter=new ozpIwc.PacketRouter();
    
    var superClass=Object.getPrototypeOf(classToAugment.prototype);
    if(superClass &amp;&amp; superClass.routePacket) {
        packetRouter.defaultRoute=function(packet,context) {
            return superClass.routePacket.apply(this,arguments);
        };
    } else {
        packetRouter.defaultRoute=function(packet,context) {
            if(this.defaultRoute) {
                return this.defaultRoute.apply(this,arguments);
            } else {
                return false;
            }
        };
    }
    classToAugment.declareRoute=function(config,handler) {
        packetRouter.declareRoute(config,handler);
    };
    
    classToAugment.prototype.routePacket=function(packet,context) {
        return packetRouter.routePacket(packet,context,this);  
    };
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
