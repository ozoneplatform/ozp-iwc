<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/services/apiFilters.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpIwc"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ozpIwc.AjaxPersistenceQueue.html">ozpIwc.AjaxPersistenceQueue</a></li>
            
                <li><a href="../classes/ozpIwc.ApiBase.html">ozpIwc.ApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.html">ozpIwc.apiFilter</a></li>
            
                <li><a href="../classes/ozpIwc.apiFilter.Function.html">ozpIwc.apiFilter.Function</a></li>
            
                <li><a href="../classes/ozpIwc.ApiNode.html">ozpIwc.ApiNode</a></li>
            
                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
            
                <li><a href="../classes/ozpIwc.BadActionError.html">ozpIwc.BadActionError</a></li>
            
                <li><a href="../classes/ozpIwc.BadContentError.html">ozpIwc.BadContentError</a></li>
            
                <li><a href="../classes/ozpIwc.BadRequestError.html">ozpIwc.BadRequestError</a></li>
            
                <li><a href="../classes/ozpIwc.BadResourceError.html">ozpIwc.BadResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.BadStateError.html">ozpIwc.BadStateError</a></li>
            
                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
            
                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
            
                <li><a href="../classes/ozpIwc.ClientParticipant.html">ozpIwc.ClientParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiBase.html">ozpIwc.CommonApiBase</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiCollectionValue.html">ozpIwc.CommonApiCollectionValue</a></li>
            
                <li><a href="../classes/ozpIwc.CommonApiValue.html">ozpIwc.CommonApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
            
                <li><a href="../classes/ozpIwc.DataNode.html">ozpIwc.DataNode</a></li>
            
                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
            
                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
            
                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
            
                <li><a href="../classes/ozpIwc.IntentsInFlightNode.html">ozpIwc.IntentsInFlightNode</a></li>
            
                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
            
                <li><a href="../classes/ozpIwc.LeaderGroupParticipant.html">ozpIwc.LeaderGroupParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Bound.html">ozpIwc.Lifespan.Bound</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Ephemeral.html">ozpIwc.Lifespan.Ephemeral</a></li>
            
                <li><a href="../classes/ozpIwc.Lifespan.Persistent.html">ozpIwc.Lifespan.Persistent</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApi.html">ozpIwc.LocksApi</a></li>
            
                <li><a href="../classes/ozpIwc.LocksApiValue.html">ozpIwc.LocksApiValue</a></li>
            
                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
            
                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
            
                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
            
                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
            
                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
            
                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
            
                <li><a href="../classes/ozpIwc.NamesNode.html">ozpIwc.NamesNode</a></li>
            
                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
            
                <li><a href="../classes/ozpIwc.NoActionError.html">ozpIwc.NoActionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoMatchError.html">ozpIwc.NoMatchError</a></li>
            
                <li><a href="../classes/ozpIwc.NoPermissionError.html">ozpIwc.NoPermissionError</a></li>
            
                <li><a href="../classes/ozpIwc.NoResourceError.html">ozpIwc.NoResourceError</a></li>
            
                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
            
                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
            
                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
            
                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
            
                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
            
                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
            
                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
            
                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
            
                <li><a href="../classes/ozpIwc.standardApiFilters.html">ozpIwc.standardApiFilters</a></li>
            
                <li><a href="../classes/ozpIwc.SystemNode.html">ozpIwc.SystemNode</a></li>
            
                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
            
                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
            
                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
            
                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/bus.html">bus</a></li>
            
                <li><a href="../modules/bus.api.html">bus.api</a></li>
            
                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
            
                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
            
                <li><a href="../modules/bus.network.html">bus.network</a></li>
            
                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
            
                <li><a href="../modules/bus.security.html">bus.security</a></li>
            
                <li><a href="../modules/bus.service.html">bus.service</a></li>
            
                <li><a href="../modules/bus.service.Type.html">bus.service.Type</a></li>
            
                <li><a href="../modules/bus.service.Value.html">bus.service.Value</a></li>
            
                <li><a href="../modules/bus.service.Value.Persistance.html">bus.service.Value.Persistance</a></li>
            
                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
            
                <li><a href="../modules/bus.util.html">bus.util</a></li>
            
                <li><a href="../modules/client.html">client</a></li>
            
                <li><a href="../modules/common.html">common</a></li>
            
                <li><a href="../modules/metrics.html">metrics</a></li>
            
                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
            
                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
            
                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app/js/services/apiFilters.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * A collection of filter generation functions.
 *
 * @class apiFilter
 * @namespace ozpIwc
 * @static
 */

/**
 * @class ozpIwc.apiFilter.Function
 * @type {Function}
 * @param {type} packet
 * @param {type} context
 * @param {type} pathParams
 * @param {type} next
 * @returns {Function} a call to the next filter
 */

ozpIwc.apiFilter={
    /**
     * Returns a filter function with the following features:
     * Stores the resource in context.node, creating it via the api&#x27;s
     * @method createResource
     * @returns {ozpIwc.apiFilter.Function}
     */
    createResource: function(NodeType) {
        if(NodeType) {
            return function(packet,context,pathParams,next) {
                if(!context.node) {
                    context.node=this.data[packet.resource]=new NodeType({
                        resource: packet.resource,
                        pattern: packet.pattern,
                        src: packet.src
                    });
                }
                return next();
            };
        } else {
            return function(packet,context,pathParams,next) {
                if(!context.node) {
                    context.node=this.createNode({
                        resource: packet.resource,
                        pattern: packet.pattern,
                        src: packet.src
                    });
                }
                return next();
            };
        }
    },
    /**
     * Returns a filter function with the following features:
     * Adds the resource as a collector to the API, it will now get updates based on its pattern property.
     * @method markAsCollector
     * @returns {Function}
     */
    markAsCollector: function(){

        return function(packet,context,pathParams,next) {
            this.addCollector(context.node);
            return next();
        };
    },

    /**
     * Returns a filter function with the following features:
     * Stores the resource in context.node or throws NoResourceError if it does not exist.
     * @method requireResource
     * @returns {ozpIwc.apiFilter.Function}
     */
    requireResource: function() {
        return function(packet,context,pathParams,next) {
            if(!context.node || context.node.deleted) {
                throw new ozpIwc.NoResourceError(packet);
            }
            return next();
        };
    },

    /**
     * Returns a filter function with the following features:
     * Checks that the subject within the context is authorized for the action on the resource node.
     * @method checkAuthorization
     * @returns {ozpIwc.apiFilter.Function}
     */
    checkAuthorization: function(action) {
        return function(packet,context,pathParams,next) {
            this.checkAuthorization(context.node,context,packet,action || packet.action);
            return next();
        };
    },

    /**
     * An empty filter
     *
     * @method nullFilter
     * @param packet
     * @param context
     * @param pathParams
     * @param next
     * @returns {Function} a call to the next filter
     */
    nullFilter: function(packet,context,pathParams,next) {
        return next();
    },

    /**
     * Returns a filter function with the following features:
     * Checks that the content type is one that is authorized for the api resource.
     * @method checkContentType
     * @returns {ozpIwc.apiFilter.Function}
     */
    checkContentType: function(contentType) {
        if(!contentType) {
            return ozpIwc.apiFilter.nullFilter;
        }
        contentType=ozpIwc.util.ensureArray(contentType);
        return function(packet,context,pathParams,next) {
            if(!contentType.some(function(t) {
                return t===packet.contentType ||
                    (Object.prototype.toString.call(contentType) === &#x27;[object RegExp]&#x27; &amp;&amp; 
                    t.test(packet.contentType));
                })
            ) {
                throw new ozpIwc.BadContentError({
                    &#x27;provided&#x27;: packet.contentType,
                    &#x27;allowedTypes&#x27;: contentType
                });
            }
            return next();
        };
    },

    /**
     * Returns a filter function with the following features:
     * Marks the resource as changed.
     * @method markResourceAsChanged
     * @returns {ozpIwc.apiFilter.Function}
     */
    markResourceAsChanged: function() { 
        return function(packet,context,pathParams,next) {
            this.markForChange(packet);
            return next();
        };
    },

    /**
     * Returns a filter function with the following features:
     * If the packet does not contain a pattern property create one from the packet resource + &quot;/&quot;. This filter is to
     * be used only in node creation as it can overwrite the nodes pattern property if different than resource + &quot;/&quot;.
     * @method fixPattern
     * @returns {Function}
     */
    fixPattern: function(){
        return function(packet,context,pathParams,next) {
            var pattern;
            if(context.node){
                pattern = context.node.pattern;
            }
            if(packet.resource) {
                packet.pattern = packet.pattern || pattern || packet.resource + &quot;/&quot;;
            }
            return next();
        };
    },

    /**
     * Returns a filter function with the following features:
     * Checks the version of the packet against the context.
     * @method checkVersion
     * @returns {ozpIwc.apiFilter.Function}
     */
    checkVersion: function() { 
        return function(packet,context,pathParams,next) {
        // if there is no resource node, then let the request through
        if(packet.ifTag &amp;&amp; packet.ifTag!==context.node.version) {
            throw new ozpIwc.NoMatchError({
                expectedVersion: packet.ifTag,
                actualVersion: context.node.version
            });
        }
        return next();
    };}
};

/**
 * Wrappers that return the list of filters for a standard action
 *
 * @class standardApiFilters
 * @namespace ozpIwc
 * @static
 */
ozpIwc.standardApiFilters={
    /**
     * Returns the filter collection generator for the given action.
     * @method forAction
     * @param {String} a
     * @returns {Function}
     */
    forAction: function(a) {
        return ozpIwc.standardApiFilters[a+&quot;Filters&quot;];
    },

    /**
     * Filters for the set action.
     * @method setFilters
     * @param nodeType
     * @param contentType
     * @returns {Function[]} array of filters
     */
    setFilters: function(nodeType,contentType) {
        return [
            ozpIwc.apiFilter.createResource(nodeType),
            ozpIwc.apiFilter.checkAuthorization(),
            ozpIwc.apiFilter.checkContentType(contentType),
            ozpIwc.apiFilter.checkVersion(),
            ozpIwc.apiFilter.markResourceAsChanged()
        ];
    },

    /**
     * Filters for the delete action.
     * @method deleteFilters
     * @returns {Function[]} array of filters
     */
    deleteFilters: function() {
        return [
            ozpIwc.apiFilter.checkAuthorization(),
            ozpIwc.apiFilter.checkVersion(),
            ozpIwc.apiFilter.markResourceAsChanged()
        ];
    },

    /**
     * Filters for the get action.
     * @method getFilters
     * @returns {Function[]} array of filters
     */
    getFilters: function() {
        return [
            ozpIwc.apiFilter.requireResource(),
            ozpIwc.apiFilter.checkAuthorization()
        ];
    },

    /**
     * Filters for set-like actions that need to mark the resource as a collector.
     * @method getFilters
     * @returns {Function[]} array of filters
     */
    createAndCollectFilters: function(nodeType,contentType) {
        return [
            ozpIwc.apiFilter.fixPattern(),
            ozpIwc.apiFilter.createResource(nodeType),
            ozpIwc.apiFilter.checkAuthorization(),
            ozpIwc.apiFilter.checkContentType(contentType),
            ozpIwc.apiFilter.checkVersion()
        ];
    }
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
